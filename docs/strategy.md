# 📋 파일 확장자 차단 과제 전략

**작성자**: 우종호  
**작성일**: 2025.10.16

---

## 📑 목차

1. [과제에 대한 해석](#1-과제에-대한-해석)
2. [방어 전략 요약](#2-방어-전략-요약)
3. [시나리오](#3-시나리오)
   - [1단계: 악성 파일을 직접 업로드한다면?](#-1단계-악성-파일을-직접-업로드한다면)
   - [2단계: 확장자를 변경해서 업로드한다면?](#-2단계-확장자를-변경해서-업로드한다면)
   - [3단계: 압축 파일 내부에 악성 파일을 숨겨 업로드한다면?](#-3단계-압축-파일-내부에-악성-파일을-숨겨-업로드한다면)
   - [4단계: 정상 파일의 메타데이터에 악성 코드를 넣어 업로드한다면?](#-4단계-정상-파일의-메타데이터에-악성-코드를-넣어-업로드한다면)

---

## 1. 과제에 대한 해석

과제 설명란에 의하면 **의도하지 않은 파일이 서버에 올라가 실행되는 경우를 차단**하기 위해서입니다. 

따라서, 이번 과제의 핵심은 **원하지 않는 확장자가 Database에 도달하지 못하게 하는 것**입니다.

### 전략

요건을 충족하는 선에서, **공격자가 되는 시나리오를 구성** 후 **단계별로 막는 방법**으로 과제를 해결하겠습니다.

---

## 2. 방어 전략 요약

```
┌────────────────────────────────────────────┐
│  "서버에서 실행하지 못하게"가 최종 목표입니다.   │
└────────────────────────────────────────────┘

1순위: 확장자 Blacklist 
└─ .bat, .cmd, .vbs, .ps1, .sh, .php, .exe 등 차단 파일명으로 차단

2순위: Apache Tika 매직 넘버 검증 
└─ 바이너리 실행 파일 감지 (.exe, .elf)
 
3순위: 서버에서 실행하지 못하게 
└─ 설령 악성 파일이 업로드되어도 실행 불가능
```

---

## 3. 시나리오

### 📌 1단계: 악성 파일을 직접 업로드한다면?

**👉 Frontend와 Backend에서 확장자 Blacklist로 차단합니다.**

> 🚨 **공격 시나리오**  
> `flow.bat` 업로드

#### 방어 시나리오

##### 🎨 Frontend (1차 차단)
- **방법**: 백엔드에서 차단 확장자 목록(Blacklist)을 받아서 파일의 마지막 확장자를 검사
- **차단 대상**: `.bat`, `.cmd`, `.exe`, `.sh`, `.php`, `.vbs`, `.ps1` 등

##### ⚙️ Backend (2차 차단)
- **직접 호출 방어를 위해** 서버 측에서 재검증
- **방법**: 확장자 Blacklist 재확인
- **최종 방어선**: 서버에서 실행하지 못하도록 설정

---

### 📌 2단계: 확장자를 변경해서 업로드한다면?

**👉 Apache Tika로 매직 넘버를 검증하여 실제 파일 타입을 확인합니다. (단, 텍스트 스크립트는 확장자 Blacklist가 주 방어선)**

> 🚨 **공격 시나리오**
> 
> 이름은 `.jpg`이지만 실제로는 실행 파일

**공격 케이스**:
- **케이스 1**: `malware.exe` → `malware.jpg` (바이너리 실행 파일)
- **케이스 2**: `script.bat` → `script.jpg` (텍스트 스크립트)
- **케이스 3**: `virus.sh` → `virus.png` (Unix 쉘 스크립트)

#### 방어 시나리오

##### ⚙️ Backend (확장자 + 매직 넘버 검증)

**방어 우선순위**:

**1순위: 확장자 Blacklist** (가장 중요!)
- 파일명이 `.jpg`여도 확장자 재확인
- 텍스트 스크립트 차단 (`.bat`, `.cmd`, `.vbs`, `.ps1`, `.sh`, `.php` 등)
- ⚠️ 이 파일들은 **매직 넘버가 없어서** 확장자로만 차단 가능

**2순위: Apache Tika 매직 넘버 검증** (보조)
- 바이너리 실행 파일 감지:
  - PE (Windows .exe): `4D 5A` (MZ)
  - ELF (Linux): `7F 45 4C 46` (.ELF)
- 이름을 `.jpg`로 바꿔도 실제 내용으로 감지 ✅

**3순위: 서버 실행 방지** (최종 방어선)
- 설령 업로드되어도 서버에서 실행 불가능하게 설정

**Apache Tika의 한계**:
- ⚠️ BAT, CMD, VBS, PS1, SH 같은 **텍스트 기반 스크립트는 매직 넘버가 없음**
- Apache Tika의 패턴 매칭도 100% 감지 못할 수 있음
- **따라서 확장자 Blacklist가 주 방어선!**

---

### 📌 3단계: 압축 파일 내부에 악성 파일을 숨겨 업로드한다면?

**👉 압축 파일을 임시 해제하여 내부 파일을 재귀적으로 검증하고, Zip Bomb는 압축률로 차단합니다.**

> 🚨 **공격 시나리오**
> 
> `.zip`, `.tar`, `.rar` 내부에 실행 파일 포함

#### 공격 원리

**케이스 1: 내부 파일 숨기기**
```
malware.zip 구조:
├─ document.pdf (정상 파일)
├─ readme.txt (정상 파일)
└─ virus.bat (악성 파일 숨김) ⚠️

ZIP 매직 넘버: 50 4B 03 04 (정상) ✅
→ 2단계 매직 넘버 검증 통과
→ 하지만 내부에 악성 파일 포함!
```

**케이스 2: Zip Bomb (압축 폭탄)**
```
zipbomb.zip (42KB)
└─ 압축 해제 시 → 4.5 TB! 💣

압축률 예시: 1MB → 5GB (5,000배)
→ 서버 디스크 가득 참
→ 서버 다운 ⚠️
```

#### 방어 시나리오

##### ⚙️ Backend (내부 재귀 검증 + Zip Bomb 차단)

**방어 방법 1: 압축 파일 내부 스캔**

**사용 라이브러리**:
- Apache Commons Compress
- 7-Zip (XZ Utils)

**검증 절차**:
1. **압축 파일 임시 해제**
   - 서버 메모리 또는 임시 디렉토리에 추출

2. **내부 파일 재귀 검증**
   - 각 파일마다 확장자 Blacklist 확인
   - 각 파일마다 매직 넘버 검증 (Apache Tika)
   - 차단 확장자 발견 시 전체 업로드 거부
   - 차단 대상: `.bat`, `.exe`, `.dll`, `.js`, `.vbs`, `.sh` 등

3. **중첩 압축 파일 검증**
   - 압축 파일 안에 또 다른 압축 파일이 있을 수 있음
   - 재귀적으로 모든 레벨 검증 (최대 깊이 3단계)

4. **비밀번호 걸린 압축 파일 차단**
   - 내부 검증 불가능 → 차단

**방어 방법 2: Zip Bomb 차단**

**검증 항목**:
1. **압축 해제 크기 제한**
   - 압축 파일 크기: 1MB
   - 압축 해제 예상 크기: 100MB 이상
   - **압축률 100배 이상 → 차단** ⚠️

2. **압축 해제 시 실시간 모니터링**
   - 해제된 총 크기가 임계값 초과 시 즉시 중단
   - 예: 총 500MB 해제 시 중단

3. **파일 개수 제한**
   - 압축 파일 내부 파일 개수: 최대 1,000개

**최종 방어선**: 설령 악성 파일이 포함된 ZIP이 저장되어도, 서버에서 해제하지 않으면 실행 불가 ✅

---

### 📌 4단계: 정상 파일의 메타데이터에 악성 코드를 넣어 업로드한다면?

**👉 서버에서 파일 실행을 금지하면 메타데이터에 코드가 있어도 실행되지 않습니다. (추가: 이미지 재인코딩으로 메타데이터 제거)**

> 🚨 **공격 시나리오**
> 
> 이름은 `.jpg`, 매직 넘버도 `.jpg` (정상)  
> 하지만 **메타데이터에 실행 코드 삽입** (Polyglot)

#### 공격 원리 상세

| 정상 JPEG | Polyglot 파일 |
|-----------|--------------|
| `┌─────────────────────────────┐` | `┌─────────────────────────────┐` |
| `│ FF D8 FF E0 (JPEG 매직 넘버) │` | `│ FF D8 FF E0 (JPEG 매직 넘버) │` |
| `├─────────────────────────────┤` | `├─────────────────────────────┤` |
| `│ EXIF 메타데이터              │` | `│ EXIF 메타데이터              │` |
| `│ Comment: 촬영 정보...        │` | `│ Comment: <?php              │` |
| `│                             │` | `│   system($_GET['cmd']);     │` |
| `│                             │` | `│ ?>                          │` |
| `├─────────────────────────────┤` | `├─────────────────────────────┤` |
| `│ 이미지 데이터 (픽셀)         │` | `│ 이미지 데이터 (픽셀)         │` |
| `└─────────────────────────────┘` | `└─────────────────────────────┘` |
| 정상 ✅ | Apache Tika: `image/jpeg` ✅ 통과<br>이미지 뷰어: 정상 표시 ✅<br>서버 `.jpg`를 PHP 실행 시 ⚠️ 위험 |

**핵심**: 매직 넘버는 정상이라 2단계 방어를 우회함!

#### 방어 시나리오

##### ⚙️ Backend

**방어 방법: 서버에서 실행하지 못하게** (최종 방어선!)
- 저장 디렉토리에서 **서버 사이드 스크립트 실행 완전 금지**
  - PHP, ASP, JSP 등 모든 실행 차단
- 업로드 파일을 정적 파일로만 서빙
- **파일 확장자와 관계없이 코드 실행 불가능하게 설정**
- 실행 권한 제거 (`chmod 644`)
- CDN/Object Storage(S3) 사용 (정적 파일로만 제공)

**추가 방어: 이미지 재인코딩** (선택 사항)
- 이미지 파일만 서버에서 다시 인코딩
- EXIF 메타데이터 완전 제거 → 악성 코드 삭제
- ⚠️ 하지만 실행 방지가 근본 해결책

**핵심**: 어떤 파일이든 **서버에서 실행만 안 되면** Polyglot 공격도 무력화됨!

---

## 4. 기술 스택

**Backend**:
- Spring Boot
- Apache Tika (매직 넘버 자동 감지)
- Apache Commons Compress (압축 파일 검증)
- PostgreSQL

**Frontend**:
- React

**Infra**:
- Docker Compose (로컬 개발)
- Nginx/Apache (실행 금지 설정)
- 선택: AWS S3 (정적 파일 저장소)
