# 파일 확장자 차단 과제 전략

**작성자**: 우종호  
**작성일**: 2025.10.16

---

## 목차

1. [과제에 대한 해석](#1-과제에-대한-해석)
2. [방어 전략 요약](#2-방어-전략-요약)
3. [시나리오](#3-시나리오)
   - [1단계: 악성 파일을 직접 업로드한다면?](#-1단계-악성-파일을-직접-업로드한다면)
   - [2단계: 확장자를 변경해서 업로드한다면?](#-2단계-확장자를-변경해서-업로드한다면)
   - [3단계: 압축 파일 내부에 악성 파일을 숨겨 업로드한다면?](#-3단계-압축-파일-내부에-악성-파일을-숨겨-업로드한다면)
   - [4단계: 모든 검증을 우회한 파일이 저장된다면?](#-4단계-모든-검증을-우회한-파일이-저장된다면)

---

## 1. 과제에 대한 해석

과제 설명란에 의하면 **의도하지 않은 파일이 서버에 올라가 실행되는 경우를 차단**하기 위해서입니다. 

따라서, 이번 과제의 핵심은 **원하지 않는 확장자가 Database에 도달하지 못하게 하는 것**입니다.

### 전략

요건을 충족하는 선에서, **공격자가 되는 시나리오를 구성** 후 **단계별로 막는 방법**으로 과제를 해결하겠습니다.

---

## 2. 방어 전략 요약

```
┌────────────────────────────────────────────┐
│  "서버에서 실행하지 못하게"가 최종 목표입니다.   │
└────────────────────────────────────────────┘

1단계: 확장자 Blacklist 검증
└─ Space별 차단 확장자 목록과 비교 (.bat, .cmd, .exe, .sh 등)

2단계: Apache Tika 매직바이트 검증
└─ 실행 파일 감지 (PE, ELF) + 확장자 위장 탐지

3단계: 압축 파일 내부 검증
└─ 재귀적 내부 스캔 + Zip Bomb 차단 + 중첩 깊이 제한

4단계: 파일 저장 및 권한 제거
└─ chmod 644 적용 → 실행 권한 완전 제거 (최종 방어선)
```

---

## 3. 시나리오

### 1단계: 악성 파일을 직접 업로드한다면?

**Frontend와 Backend에서 확장자 Blacklist로 차단합니다.**

> **공격 시나리오**  
> `flow.bat` 업로드

#### 방어 시나리오

##### Frontend (1차 차단)
- **방법**: 백엔드에서 차단 확장자 목록(Blacklist)을 받아서 파일의 마지막 확장자를 검사
- **차단 대상**: `.bat`, `.cmd`, `.exe`, `.sh`, `.php`, `.vbs`, `.ps1` 등

##### Backend (2차 차단)
- **직접 호출 방어를 위해** 서버 측에서 재검증
- **방법**: 확장자 Blacklist 재확인
- **최종 방어선**: 서버에서 실행하지 못하도록 설정

---

### 2단계: 확장자를 변경해서 업로드한다면?

**Apache Tika로 매직 넘버를 검증하여 실제 파일 타입을 확인합니다. (단, 텍스트 스크립트는 확장자 Blacklist가 주 방어선)**

> **공격 시나리오**
> 
> 이름은 `.jpg`이지만 실제로는 실행 파일

**공격 케이스**:
- **케이스 1**: `malware.exe` → `malware.jpg` (바이너리 실행 파일)
- **케이스 2**: `script.bat` → `script.jpg` (텍스트 스크립트)
- **케이스 3**: `virus.sh` → `virus.png` (Unix 쉘 스크립트)

#### 방어 시나리오

##### Backend (확장자 + 매직 넘버 검증)

<<<<<<< HEAD
=======
**방어 우선순위**:

**1순위: 확장자 Blacklist** (가장 중요!)
- 파일명이 `.jpg`여도 확장자 재확인
- 텍스트 스크립트 차단 (`.bat`, `.cmd`, `.vbs`, `.ps1`, `.sh`, `.php` 등)
- 이 파일들은 **매직 넘버가 없어서** 확장자로만 차단 가능

**2순위: Apache Tika 매직 넘버 검증** (보조)
- 바이너리 실행 파일 감지:
  - PE (Windows .exe): `4D 5A` (MZ)
  - ELF (Linux): `7F 45 4C 46` (.ELF)
- 이름을 `.jpg`로 바꿔도 실제 내용으로 감지

**3순위: 서버 실행 방지** (최종 방어선)
- 설령 업로드되어도 서버에서 실행 불가능하게 설정

**Apache Tika의 한계**:
- BAT, CMD, VBS, PS1, SH 같은 **텍스트 기반 스크립트는 매직 넘버가 없음**
- Apache Tika의 패턴 매칭도 100% 감지 못할 수 있음
- **따라서 확장자 Blacklist가 주 방어선!**
>>>>>>> c292ffc116b541d796a8af569b1d39e4d8155bfe

---

### 3단계: 압축 파일 내부에 악성 파일을 숨겨 업로드한다면?

**압축 파일을 임시 해제하여 내부 파일을 재귀적으로 검증하고, Zip Bomb는 압축률로 차단합니다.**

> **공격 시나리오**
> 
> `.zip`, `.tar`, `.rar` 내부에 실행 파일 포함

#### 공격 원리

**케이스 1: 내부 파일 숨기기**
```
malware.zip 구조:
├─ document.pdf (정상 파일)
├─ readme.txt (정상 파일)
└─ virus.bat (악성 파일 숨김)

ZIP 매직 넘버: 50 4B 03 04 (정상)
→ 2단계 매직 넘버 검증 통과
→ 하지만 내부에 악성 파일 포함!
```

**케이스 2: Zip Bomb (압축 폭탄)**
```
zipbomb.zip (42KB)
└─ 압축 해제 시 → 4.5 TB!

압축률 예시: 1MB → 5GB (5,000배)
→ 서버 디스크 가득 참
→ 서버 다운
```

#### 방어 시나리오

##### Backend (내부 재귀 검증 + Zip Bomb 차단)

**방어 방법 1: 압축 파일 내부 스캔**

**사용 라이브러리**:
- Apache Commons Compress
- 7-Zip (XZ Utils)

**검증 절차**:
1. **압축 파일 임시 해제**
   - 서버 메모리 또는 임시 디렉토리에 추출

2. **내부 파일 재귀 검증**
   - 각 파일마다 확장자 Blacklist 확인
   - 각 파일마다 매직 넘버 검증 (Apache Tika)
   - 차단 확장자 발견 시 전체 업로드 거부
   - 차단 대상: `.bat`, `.exe`, `.dll`, `.js`, `.vbs`, `.sh` 등


**방어 방법 2: Zip Bomb 차단**

<<<<<<< HEAD
### 4단계: 모든 검증을 우회한 파일이 저장된다면?
=======
**검증 항목**:
1. **압축 해제 크기 제한**
   - 압축 파일 크기: 1MB
   - 압축 해제 예상 크기: 100MB 이상
   - **압축률 100배 이상 → 차단**
>>>>>>> c292ffc116b541d796a8af569b1d39e4d8155bfe

**파일 저장 시 실행 권한을 완전히 제거하여 최종 방어선을 구축합니다.**

<<<<<<< HEAD
=======
3. **파일 개수 제한**
   - 압축 파일 내부 파일 개수: 최대 1,000개

**최종 방어선**: 설령 악성 파일이 포함된 ZIP이 저장되어도, 서버에서 해제하지 않으면 실행 불가

---

### 4단계: 모든 검증을 우회한 파일이 저장된다면?

**파일 저장 시 실행 권한을 완전히 제거하여 최종 방어선을 구축합니다.**

>>>>>>> c292ffc116b541d796a8af569b1d39e4d8155bfe
> **공격 시나리오**
> 
> 1~3단계를 모두 우회한 악성 파일이 서버에 저장됨  
> 공격자가 저장된 파일의 **실행 권한을 획득하려 시도**

**공격 케이스**:
- **케이스 1**: 서버 취약점을 통해 파일 권한을 `chmod 777`로 변경 시도
- **케이스 2**: 웹 쉘을 통한 파일 실행 시도
- **케이스 3**: 잘못된 디렉토리 설정으로 업로드 파일이 실행 가능 영역에 저장됨

#### 방어 시나리오

##### Backend (파일 저장 및 권한 제거)

**방어 방법 1: 파일 권한 제한 (chmod 644)**

저장 즉시 실행 권한 완전 제거:
```bash
# 저장 전 기본 권한 (위험)
-rwxrwxrwx  malicious.sh  # 모든 사용자 실행 가능 (위험)

# 저장 후 권한 설정 (안전)
-rw-r--r--  malicious.sh  # 읽기만 가능, 실행 불가
```

<<<<<<< HEAD
=======
**구현 코드**:
```java
// 파일 저장 후 즉시 권한 제거
Path savedFile = Paths.get(filePath);
Set<PosixFilePermission> perms = new HashSet<>();
perms.add(PosixFilePermission.OWNER_READ);
perms.add(PosixFilePermission.OWNER_WRITE);
perms.add(PosixFilePermission.GROUP_READ);
perms.add(PosixFilePermission.OTHERS_READ);
Files.setPosixFilePermissions(savedFile, perms);  // chmod 644
```

**방어 방법 2: 저장 디렉토리 격리**
- 업로드 디렉토리를 웹 루트 외부에 위치
- 정적 파일로만 서빙 (코드 실행 불가 설정)
- 예: `/Volumes/USB_WOO_2TB/flow-file-storage`

**방어 방법 3: UUID 기반 파일명**
- 원본 파일명 대신 UUID 사용
- 확장자 기반 실행 우회 방지
- 예: `malicious.sh` → `f1a2b3c4-d5e6-7890-abcd-ef1234567890.sh`

>>>>>>> c292ffc116b541d796a8af569b1d39e4d8155bfe
**핵심**: 어떤 파일이든 **실행 권한이 없으면** 서버에서 실행 불가!

---
